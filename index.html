<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>المساعد الذكي</title>

<style>
:root{--ink:#0f172a;--muted:#64748b;--sky-25:#f3f9ff;--sky-50:#eaf4ff;--sky-100:#e1f0ff;--btn:#1d97ff;--btn2:#0ea5e9;--card:#fff;--radius:16px}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;color:var(--ink);font-family:system-ui,-apple-system,'Segoe UI',Cairo,Roboto,sans-serif;background:
  radial-gradient(900px 500px at 0% -10%,var(--sky-100),transparent 60%),
  radial-gradient(900px 500px at 100% 110%,var(--sky-50),transparent 60%),
  linear-gradient(180deg,#fff,var(--sky-25) 85%)}
.wrap{max-width:1100px;margin:0 auto;padding:22px;min-height:100vh;display:flex;flex-direction:column}
header{text-align:center;margin:6px 0 16px}
header h1{font-size:clamp(26px,4.6vw,40px);margin:6px 0 4px;font-weight:900}
header p{color:var(--muted);margin:4px 0 0;font-size:clamp(14px,2.3vw,17px)}
.card{background:var(--card);border:1px solid rgba(2,132,199,.15);border-radius:var(--radius);box-shadow:0 12px 30px rgba(2,132,199,.10)}
.pad{padding:14px}
.inputs-container{display:flex;flex-direction:column;gap:12px}
.input-row{display:flex;flex-direction:column;width:100%}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px;position:relative;z-index:1}
.btn{background:linear-gradient(180deg,var(--btn),var(--btn2));color:#fff;border:none;padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer;box-shadow:0 10px 20px rgba(14,165,233,.25);font-size:clamp(14px,2.4vw,16px);user-select:none;touch-action:manipulation}
.btn:disabled{opacity:.6;cursor:not-allowed}
.btn:active{transform:translateY(1px)}
.status{color:var(--muted);font-size:.95rem;text-align:center;min-height:1.2em;margin-top:6px}
.err{background:#fee2e2;color:#991b1b;border:1px solid #fecaca;padding:10px;border-radius:12px;display:none;margin-top:10px}
.sec{display:none;margin-top:12px}
.box{background:#f6fbff;border:1px solid #dbeafe;padding:12px;border-radius:12px}
.box ul,.box ol{margin:0 0 0 1.2rem}
.tag{display:inline-block;padding:.28rem .7rem;border-radius:999px;background:var(--sky-100);border:1px solid #cfe7ff;color:#0c4a6e;font-size:.9rem}
.math-inline,.math-block{direction:ltr;unicode-bidi:isolate}
.math-block{display:block;margin:.25rem 0}
footer{margin-top:auto;text-align:center;color:#64748b;padding:16px 0 40px;display:flex;flex-direction:column;align-items:center}
footer .teacher{color:#0f172a;font-weight:900;font-size:clamp(16px,3vw,20px);margin-top:10px}
footer .school{font-size:clamp(13px,2.2vw,15px)}
.select,.input{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;font-size:1rem}
.input-row{max-width:500px;margin:0 auto}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:720px){.row{grid-template-columns:1fr}}
</style>

<!-- MathJax -->
<script>
window.MathJax={
  tex:{
    inlineMath:[['$','$'],['\\(','\\)']],
    displayMath:[['$$','$$'],['\\[','\\]']],
    processEscapes:true,
    packages:{'[+]':['noerrors','noundefined']}
  }
};
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
</head>
<body>
<div class="wrap">
<header>
  <h1>المساعد الذكي 🤖</h1>
  <p>وجهتك الأولى لتبسيط قوانين <strong>الفيزياء والكيمياء والرياضيات</strong>.</p>
</header>

<section class="card pad">
  <div class="inputs-container">
    <div class="input-row">
      <label for="subject">المادة</label>
      <select id="subject" class="select">
        <option>الفيزياء</option><option>الكيمياء</option><option>الرياضيات</option>
      </select>
    </div>
    <div class="input-row">
      <label for="concept">أدخل القانون/المفهوم (بالنص أو بالرموز):</label>
      <input id="concept" class="input" placeholder="السقوط الحر — عدد المولات — فيثاغورس" autocomplete="off"/>
    </div>
  </div>

  <div class="toolbar" role="group" aria-label="الأوامر">
    <button type="button" class="btn" id="btnExplain">اشرح القانون 📘</button>
    <button type="button" class="btn" id="btnEx1">مثال تطبيقي 💡</button>
    <button type="button" class="btn" id="btnEx2">مثال آخر 💡</button>
    <button type="button" class="btn" id="btnPractice">مسألة تدريبية 📝</button>
    <button type="button" class="btn" id="btnSolve">عرض الحل الصحيح 🔑</button>
  </div>

  <div id="status" class="status" aria-live="polite"></div>
  <div id="error" class="err" role="alert"></div>
</section>

<section id="secExplain" class="sec card pad" aria-live="polite">
  <h2 id="exTitle" style="margin-top:0"></h2>
  <div style="display:flex;gap:8px;flex-wrap:wrap;margin:-4px 0 8px">
    <span id="chip1" class="tag"></span><span id="chip2" class="tag"></span>
  </div>
  <h3>التعريف المختصر</h3>
  <div id="overview" class="box"></div>

  <div class="row" style="margin-top:10px">
    <div>
      <h3>الصيغ</h3><ul id="formulas" class="box"></ul>
    </div>
    <div>
      <h3>الرموز</h3><ul id="symbols" class="box"></ul>
    </div>
  </div>

  <h3 style="margin-top:10px">خطوات الاستخدام/الحل</h3>
  <ol id="steps" class="box"></ol>
</section>

<section id="secEx1" class="sec card pad"><h2>مثال تطبيقي</h2><div id="ex1" class="box"></div></section>
<section id="secEx2" class="sec card pad"><h2>مثال آخر</h2><div id="ex2" class="box"></div></section>
<section id="secPractice" class="sec card pad"><h2>سؤال للتدريب</h2><div id="practice" class="box"></div></section>
<section id="secSolve" class="sec card pad"><h2>الحل الصحيح</h2><div id="solve" class="box"></div></section>

<footer>
  <div>تم إنشاؤه بإتقان لتبسيط تعلّم العلوم</div>
  <div class="teacher">معلمة الفيزياء: ندى محمد المجيرش</div>
  <div class="school">التربية النموذجية – الريان</div>
</footer>
</div>

<!-- أدوات الماث/الوحدات -->
<script>
(function(){
  function cleanMath(s){
    s=(s||'').replace(/\r/g,'\n').replace(/\n{3,}/g,'\n\n');
    s=s.replace(/\\\\/g,'\\').replace(/\$approx\b/gi,'\\approx');
    return s.trim();
  }
  function hasMathDelims(s){ return /(\$\$[\s\S]*?\$\$|\$[^$]+\$|\\\(|\\\[)/.test(s||''); }
  function looksLikeMath(s){ return /[=^_]|\\(frac|sqrt|mathrm|sum|int)\b|[A-Za-z]\s*\/\s*[A-Za-z]/.test(s||''); }

  function fixLatex(s){
    s = cleanMath(s||'');
    s = s.replace(/(^|[^\\])\b(frac|sqrt|mathrm|sum|int)\b/g,'$1\\$2');
    const unitAlt = [
      'mol','g','kg','mg','µg','m','cm','mm','km','s','ms','min','h','A','V','N','Pa','kPa','MPa',
      'J','kJ','W','kW','MW','Hz','C','K','°C','L','mL','cm\\^3','dm\\^3','atm','bar','mmHg','Torr',
      'Ohm','F','H','m/s','m/s\\^2','km/h','mol/L','M','g/mol','rad','rad/s'
    ].join('|');
    const unitPlain = unitAlt.replace(/\\\^/g,'^').replace(/\\\//g,'/');
    s = s.replace(/\\\[\s*\\?mathrm\{([^}]+)\}\s*\\\]/g,'\\,\\mathrm{$1}');
    if (hasMathDelims(s)){
      s = s.replace(new RegExp('(\\d+(?:[.,]\\d+)?)\\s+('+unitAlt+')\\b','g'),'$1\\\\,\\\\mathrm{$2}');
      s = s.replace(/[\(\[\{]\s*\\?mathrm\{([^}]+)\}\s*[\)\]\}]/g,'\\,\\mathrm{$1}');
    } else {
      s = s.replace(new RegExp('(\\d+(?:[\\.,]\\d+)?)\\s*('+unitPlain+')','g'),'$$$1\\\\,\\\\mathrm{$2}$');
    }
    return s;
  }

  // ✅ يحفظ $$..$$ و $..$ ثم يمسح أي $ يتيمة
  function htmlWithMath(sp){
    let s = fixLatex(sp||'');

    // احفظ $$...$$ مؤقتًا
    const blocks = [];
    s = s.replace(/\$\$([\s\S]*?)\$\$/g,(m,inner)=>{
      blocks.push('$$'+inner+'$$');
      return '§§BLOCK'+(blocks.length-1)+'§§';
    });

    // احفظ $...$ مؤقتًا
    const inlines = [];
    s = s.replace(/\$([^$]+)\$/g,(m,inner)=>{
      inlines.push('$'+inner+'$');
      return '§§INL'+(inlines.length-1)+'§§';
    });

    // إزالة أي $ يتيمة
    s = s.replace(/\$/g,'');

    // أرجعها داخل سبانات MathJax
    s = s.replace(/§§BLOCK(\d+)§§/g,(m,i)=>`<span class="math-block">$$${blocks[i].slice(2,-2)}$$</span>`)
         .replace(/§§INL(\d+)§§/g,(m,i)=>`<span class="math-inline">$${inlines[i].slice(1,-1)}$</span>`);
    return s;
  }

  window._MathFix = { hasMathDelims, looksLikeMath, fixLatex, htmlWithMath };
})();
</script>

<!-- منع انعكاس العربي في سطر الرموز -->
<script>
(function(){
  const hasMathDelims = (s)=>window._MathFix.hasMathDelims(s);
  const looksLikeMath = (s)=>window._MathFix.looksLikeMath(s);

  function renderSymbolLine(raw){
    const s = raw || '';
    const idx = s.search(/[\u0600-\u06FF]/);
    const li = document.createElement('li');

    if (idx > 0){
      const left  = s.slice(0, idx).trim();
      const right = s.slice(idx).trim();
      const leftPrepared = hasMathDelims(left) ? left : (looksLikeMath(left) ? `$${left}$` : left);

      const span = document.createElement('span');
      span.innerHTML = window._MathFix.htmlWithMath(leftPrepared);
      li.appendChild(span);
      li.appendChild(document.createTextNode(' ' + right));
    } else {
      li.innerHTML = window._MathFix.htmlWithMath(s);
    }
    return li;
  }

  window._RTLFix = { renderSymbolLine };
})();
</script>

<!-- سكربت الواجهة -->
<script>
(function(){
  const $=(id)=>document.getElementById(id);
  const secs=['secExplain','secEx1','secEx2','secPractice','secSolve'];

  function hideAll(){
    secs.forEach(s=>$(s).style.display='none');
    const e=$('error'); if(e){ e.style.display='none'; e.textContent=''; }
  }
  function setBusy(txt){
    $('status').textContent=txt||'';
    document.querySelectorAll('.btn').forEach(b=>b.disabled=!!txt);
  }
  function showErr(msg){
    const e=$('error'); e.style.display='block';
    e.textContent=(typeof msg==='string' && msg)? ('Error: '+msg) : 'Error: حدث خطأ غير متوقع.';
  }
  function typeset(){
    if(window.MathJax && MathJax.typesetPromise){ MathJax.typesetPromise(); }
  }

  const htmlWithMath     = window._MathFix.htmlWithMath;
  const renderSymbolLine = window._RTLFix.renderSymbolLine;

  function renderExplain(d,subject,concept){
    $('exTitle').textContent = (d.title||concept||'').toString();
    $('chip1').textContent = subject; $('chip2').textContent = concept;
    $('overview').innerHTML = htmlWithMath(d.overview||'—');

    const f=$('formulas'); f.innerHTML='';
    (d.formulas||[]).forEach(s=>{const li=document.createElement('li'); li.innerHTML=htmlWithMath(s); f.appendChild(li);});

    const sy=$('symbols'); sy.innerHTML='';
    (d.symbols||[]).forEach(s=>{sy.appendChild(renderSymbolLine(s));});

    const st=$('steps'); st.innerHTML='';
    (d.steps||[]).forEach(s=>{const li=document.createElement('li'); li.innerHTML=htmlWithMath(s); st.appendChild(li);});

    $('secExplain').style.display='block'; typeset();
  }

  function renderExample(boxId,secId,d){
    const box=$(boxId); const frag=document.createDocumentFragment();
    if (d.title){ const h=document.createElement('div'); h.style.fontWeight='700'; h.textContent=d.title; frag.appendChild(h); }
    if (d.scenario){ const p=document.createElement('div'); p.innerHTML='<em>المسألة:</em> '+htmlWithMath(d.scenario); frag.appendChild(p); }

    if (Array.isArray(d.given)&&d.given.length){
      const p=document.createElement('div'); p.innerHTML='<em>المعطيات:</em>';
      const ul=document.createElement('ul');
      d.given.forEach(x=>{const li=document.createElement('li'); li.innerHTML=htmlWithMath(x); ul.appendChild(li);});
      p.appendChild(ul); frag.appendChild(p);
    }
    if (d.required){ const p=document.createElement('div'); p.innerHTML='<em>المطلوب:</em> '+htmlWithMath(d.required); frag.appendChild(p); }
    if (Array.isArray(d.steps)&&d.steps.length){
      const p=document.createElement('div'); p.innerHTML='<em>الخطوات:</em>';
      const ol=document.createElement('ol');
      d.steps.forEach(x=>{const li=document.createElement('li'); li.innerHTML=htmlWithMath(x); ol.appendChild(li);});
      p.appendChild(ol); frag.appendChild(p);
    }
    if (d.result){ const p=document.createElement('div'); p.innerHTML='<em>النتيجة:</em> '+htmlWithMath(d.result); frag.appendChild(p); }
    if (d.formula){ const div=document.createElement('div'); div.className='math-block'; div.innerHTML=htmlWithMath(d.formula); div.style.marginTop='6px'; frag.appendChild(div); }
    box.innerHTML=''; box.appendChild(frag); $(secId).style.display='block'; typeset();
  }

  function renderPractice(d){
    $('practice').innerHTML = htmlWithMath(d.question||'—');
    $('secPractice').style.display='block'; typeset();
  }

  function renderSolve(d){
    const solveBox=$('solve'); solveBox.innerHTML='';
    const solutionText=d.solution||'—';
    const parts=solutionText.split(/(\*\*[\س\S]+?\*\*)/g).filter(p=>p.trim()!=='');
    parts.forEach(part=>{
      if(part.startsWith('**')&&part.endsWith('**')){
        const h3=document.createElement('h3'); h3.style.marginTop='10px';
        h3.textContent=part.replace(/^\*\*|\*\*$/g,''); solveBox.appendChild(h3);
      }else{
        const lines=part.split(/\n+/).filter(line=>line.trim()!=='');
        if(lines.length>0){
          const ol=document.createElement('ol');
          lines.forEach(line=>{const li=document.createElement('li'); li.innerHTML=htmlWithMath(line.trim()); ol.appendChild(li);});
          solveBox.appendChild(ol);
        }
      }
    });
    $('secSolve').style.display='block'; typeset();
  }

  // حماية من الضغط المزدوج + تقارير خطأ نظيفة
  let inFlight = false;
  function go(action,extra){
    if (inFlight) return;
    hideAll();

    const subject=$('subject').value;
    const concept=($('concept').value||'').trim();
    if(!concept){ showErr('أدخل اسم القانون/المفهوم أولًا.'); return; }

    const loadingMsg={
      explain:'جارٍ توليد الشرح…',
      example:'جارٍ إنشاء المثال التطبيقي…',
      example2:'جارٍ إنشاء مثال آخر…',
      practice:'جارٍ إنشاء مسألة…',
      solve:'جارٍ الحل…'
    }[action]||'جارٍ المعالجة…';

    inFlight = true;
    setBusy(loadingMsg);

    google.script.run
      .withSuccessHandler(res=>{
        setBusy(''); inFlight=false;
        if(!res||!res.ok){ showErr((res&&res.error)||'تعذّر المعالجة.'); return; }
        const d=res.data||{};
        if(action==='explain')renderExplain(d,subject,concept);
        if(action==='example')renderExample('ex1','secEx1',d);
        if(action==='example2')renderExample('ex2','secEx2',d);
        if(action==='practice')renderPractice(d);
        if(action==='solve')renderSolve(d);
      })
      .withFailureHandler(err=>{
        setBusy(''); inFlight=false;
        const msg = (err && typeof err==='object' && err.message) ? err.message :
                    (typeof err==='string' ? err : 'فشل الاتصال بالتطبيق.');
        showErr(msg);
      })
      .doAction(action,subject,concept,extra||null);
  }

  // ربط الأزرار بعد جاهزية DOM
  window.addEventListener('DOMContentLoaded', ()=>{
    document.getElementById('btnExplain').addEventListener('click', ()=>go('explain'));
    document.getElementById('btnEx1').addEventListener('click', ()=>go('example'));
    document.getElementById('btnEx2').addEventListener('click', ()=>go('example2'));
    document.getElementById('btnPractice').addEventListener('click', ()=>go('practice'));
    document.getElementById('btnSolve').addEventListener('click', ()=>{
      const q=document.getElementById('practice').textContent?.trim();
      go('solve', q?{question:q}:null);
    }, { passive:true });
  });
})();
</script>
</body>
</html>
